---
name: tool-usage
title: 工具使用指南
description: "AI系统工具选择和应用指南，包含工具选择原则、使用规范、最佳实践和性能优化策略"
category: rule
priority: high
tags: [工具指南, 使用规范, 最佳实践]
---

# 工具使用指南

AI 系统工具选择和应用指南。

## 工具选择原则

| 优先级 | 原则         | 说明                                   |
| ------ | ------------ | -------------------------------------- |
| 1      | 内建工具优先 | 优先使用系统内置工具而非 MCP 服务工具  |
| 2      | 精确修改优先 | 外科手术式精确修改优于完全重写         |
| 3      | 批量操作优化 | 合并多个操作以提高效率                 |
| 4      | 上下文相关   | 基于任务选择最相关工具，避免过度工程化 |

## 工具使用原则

- **用户主导**：执行任何操作前必须询问用户，用户决策而非 AI 自动选择
- **最小化影响**：选择对系统影响最小的工具
- **可逆性**：优先支持撤销的操作
- **性能考虑**：考虑执行效率和资源消耗
- **模式适配**：根据当前模式选择合适工具
- **简洁性**：优先选择简单直接的解决方案

## 工具详解

### 🔍 探索与分析

**原则**：先观察，后行动。

| 工具                         | 用途                          | 限制/技巧                  |
| ---------------------------- | ----------------------------- | -------------------------- |
| `list_files`                 | 浏览项目结构，支持递归        | 首次接触项目时使用         |
| `read_file`                  | 批量读取文件内容（最多 5 个） | 单次最多 5 个文件          |
| `list_code_definition_names` | 获取代码定义概览              | 分析陌生代码库时使用       |
| `search_files`               | 正则搜索文件内容              | 使用精确正则，避免宽泛匹配 |

### ✏️ 文件编辑

**原则**：精确修改优于完全重写。

| 工具                 | 用途                   | 注意事项               |
| -------------------- | ---------------------- | ---------------------- |
| `apply_diff`         | 精确修改代码段（优先） | 最小化意外修改风险     |
| `insert_content`     | 在指定行插入内容       | 适合添加导入、函数定义 |
| `search_and_replace` | 批量查找替换           | 谨慎使用，确保范围准确 |
| `write_to_file`      | 创建新文件或完全重写   | 会覆盖整个文件内容     |

#### 文件操作优先级

| 操作类型  | 优先级顺序                                                          |
| --------- | ------------------------------------------------------------------- |
| 编辑/修改 | `apply_diff` > `search_and_replace` > `edit_file` > `write_to_file` |
| 添加内容  | `insert_content` > `write_append` > `write_to_file`                 |
| 覆盖内容  | `write_to_file`                                                     |

#### 文件处理规则

- 使用绝对路径而非相对路径
- 500 行为单位分片处理大文件
- 每次分片处理后重新加载文件
- 单次处理不超过 500 行

### 💬 交互决策

**原则**：必须询问用户，用户拥有最终决策权。

| 工具                    | 用途           | 特点                   |
| ----------------------- | -------------- | ---------------------- |
| `ask_followup_question` | 请求用户决策   | 提供清晰选项           |
| `update_todo_list`      | 更新任务清单   | 追加或更新，非完全覆盖 |
| `new_task`              | 委派给专业模式 | 详见 `new_task.md`     |

### ⚙️ 系统操作

**原则**：执行与交付作为最后环节。

| 工具                 | 用途           | 注意                     |
| -------------------- | -------------- | ------------------------ |
| `execute_command`    | 执行命令行操作 | 每个命令在新终端实例运行 |
| `attempt_completion` | 完成任务交付   | 所有工作完成后使用       |

#### 命令行操作规则

- 禁止使用 `&&` 组合命令
- 执行前分析选项优缺点
- 前置重要决策，避免返工
- 优先使用内建工具

## 性能优化

### 批量操作

- 合并多个 `read_file` 请求（最多 5 个）
- 单个 `apply_diff` 处理多个修改
- 使用脚本文件避免命令链

### 缓存策略

- 避免重复读取未修改文件
- 缓存频繁访问的配置信息
- 合理使用文件分片处理大文件

### 错误处理

- 使用适当工具处理特定错误
- 记录错误日志
- 提供清晰错误信息和恢复建议

## 最佳实践

1. **用户主导**
   - 执行任何操作前必须获得用户明确授权
   - 提供充分信息让用户做出知情决策
   - 尊重用户选择，不擅自执行未经批准的操作

2. **工具选择**
   - 根据任务性质选择最合适工具
   - 考虑性能、安全性、可维护性
   - 避免过度工程化

3. **操作顺序**
   - 先询问用户，后执行操作
   - 先探索，后修改
   - 先备份，后操作
   - 先测试，后提交

4. **错误预防**
   - 验证输入参数
   - 检查文件存在性
   - 确认操作权限
   - 执行前告知潜在风险

5. **效率优化**
   - 批量处理相似操作
   - 避免重复计算
   - 合理使用缓存

6. **简洁性**
   - 优先选择简单直接方案
   - 避免不必要的复杂性
   - 最小化工具调用次数

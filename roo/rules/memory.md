# 记忆库规范

> 记忆库是系统的核心驱动力，定义了信息的分层存储与高效检索机制。

## 四层架构

| 层级 | 路径 | 用途 | 生命周期 |
|------|------|------|----------|
| **L0 核心** | `.memory/L0_core/` | AI身份与核心指令 | 永久 |
| **L1 陈述** | `.memory/L1_declarative/` | 事实知识（规范、数据） | 持久 |
| **L2 程序** | `.memory/L2_procedural/` | 操作知识（工作流、SOP） | 持久 |
| **L3 情景** | `.memory/L3_episodic/` | 任务日志（复盘归档） | 归档 |
| **L4 工作** | `.memory/L4_working/` | 当前任务上下文 | 临时 |

**辅助目录**：`.memory/staging/`（暂存）、`.memory/.trash/`（回收）

## 核心机制

### 认知压缩
- **摘要索引**：通过`index.json`快速筛选，命中后加载完整内容
- **指针引用**：长内容替换为`mem://<layer>/<id>`，按需解析

### 状态管理
- 通过`.memory/memory.lock`标识状态：`ON`/`OFF`/`PAUSED`
- 每次响应前必须明示状态：`[记忆库: ON]`

## 执行流程

### 1. 初始化
- 任务启动时加载相关记忆构建L4
- 状态检查，不存在则提请初始化
- 需求分析参见[`decision-flow.md`](./decision-flow.md)

### 2. 执行
- 在L4上下文中执行任务
- 新信息立即写入工作记忆
- 状态更新参见[`task.md`](./task.md#状态追踪)

### 3. 沉淀
- 子任务完成立即复盘提炼价值
- 通过`ask_followup_question`提请持久化至L1/L2

### 4. 清理
- 任务结束后归档至L3
- 由orchestrator调用memory模式清理L4

## 权限管理

| 模式 | 权限 | 职责 |
|------|------|------|
| **orchestrator** | 读写 | 驱动记忆工作流，管理L4生命周期 |
| **memory** | 执行 | 提供原子操作（init/cleanup/summarize） |
| **其他模式** | 只读 | 在L4中执行，识别价值信息提请持久化 |

## 集成规范

- **决策记录**：所有决策过程记入L4，详见[`decision-flow.md`](./decision-flow.md)
- **任务评估**：复杂度评估沉淀至L2，详见[`task.md`](./task.md#任务复杂度评估)
- **工作流程**：遵循标准流程，详见[`workflow.md`](./workflow.md)

## 最佳实践

✅ **应该**
- 主动识别可复用信息并提请持久化
- 保持记忆层级清晰，避免混用
- 定期复盘提炼程序性知识

❌ **避免**
- 跳过orchestrator直接修改记忆
- 任务结束前清理L4
- 将临时信息写入持久层
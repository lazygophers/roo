name: Docker Build and Push (Master Only)

on:
  push:
    branches:
      - master
    tags:
      - "v*"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ£€æµ‹å˜æ›´æ–‡ä»¶ï¼Œå†³å®šæ˜¯å¦éœ€è¦æž„å»º
  detect-changes:
    runs-on: lazy
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      docker-changed: ${{ steps.changes.outputs.docker }}
      resources-changed: ${{ steps.changes.outputs.resources }}
      should-build: ${{ steps.should-build.outputs.result }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'frontend/package*.json'
              - 'frontend/pnpm-lock.yaml'
            backend:
              - 'app/**'
              - 'pyproject.toml'
              - 'uv.lock'
            docker:
              - 'Dockerfile'
              - 'docker-compose*.yml'
              - '.dockerignore'
            resources:
              - 'resources/**'

      - name: Determine if build is needed
        id: should-build
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ contains(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ TagæŽ¨é€ï¼Œå¼ºåˆ¶æž„å»º"
          elif [[ "${{ steps.changes.outputs.frontend }}" == "true" || "${{ steps.changes.outputs.backend }}" == "true" || "${{ steps.changes.outputs.docker }}" == "true" || "${{ steps.changes.outputs.resources }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ æ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œéœ€è¦æž„å»º"
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ æ— ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æž„å»º"
          fi

  # ä¼˜åŒ–çš„æž„å»ºå’ŒæŽ¨é€
  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'true'
    runs-on: lazy
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm for frontend cache
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache frontend build cache
        uses: actions/cache@v4
        with:
          path: |
            frontend/.next/cache
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('frontend/package*.json', 'frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-frontend-build-

      - name: Setup Python for backend cache
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-python-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-python-

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Docker build context
        uses: actions/cache@v4
        with:
          path: |
            ~/.docker/buildx
            /var/lib/docker/buildx
          key: ${{ runner.os }}-docker-buildx-${{ hashFiles('Dockerfile', 'frontend/package*.json', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-docker-buildx-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=local,src=/tmp/.buildx-cache
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache
          cache-to: |
            type=gha,mode=max
            type=local,dest=/tmp/.buildx-cache-new,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BUILDKIT_CACHE_MOUNT=true
          provenance: false
          sbom: false

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Generate build summary
        run: |
          echo "## Docker Build Summary ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes detected:**" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.detect-changes.outputs.backend-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.detect-changes.outputs.docker-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Resources: ${{ needs.detect-changes.outputs.resources-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ **Performance optimizations applied:**" >> $GITHUB_STEP_SUMMARY
          echo "- Smart change detection" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-layer Docker caching strategy" >> $GITHUB_STEP_SUMMARY
          echo "  - GitHub Actions cache (GHA)" >> $GITHUB_STEP_SUMMARY
          echo "  - Local BuildX cache (/tmp/.buildx-cache)" >> $GITHUB_STEP_SUMMARY
          echo "  - Registry cache (ghcr.io)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend dependency caching (pnpm store + build cache)" >> $GITHUB_STEP_SUMMARY
          echo "- Backend dependency caching (Python + uv)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker BuildX context caching" >> $GITHUB_STEP_SUMMARY
          echo "- BuildKit inline cache + mount cache" >> $GITHUB_STEP_SUMMARY
          echo "- pnpm for faster package management" >> $GITHUB_STEP_SUMMARY
          echo "- Optimized Docker Buildx configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Disabled SBOM/Provenance for speed" >> $GITHUB_STEP_SUMMARY

  # ä»…åœ¨æ–‡æ¡£æˆ–éžæž„å»ºæ–‡ä»¶å˜æ›´æ—¶è¿è¡Œçš„å¿«é€Ÿä½œä¸š
  skip-notification:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'false'
    runs-on: lazy
    steps:
      - name: Skip build notification
        run: |
          echo "## Build Skipped â­ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºå·²è·³è¿‡ï¼Œå› ä¸ºæ²¡æœ‰æ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥çš„è·¯å¾„:**" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`frontend/**\`" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`app/**\`, \`pyproject.toml\`, \`uv.lock\`" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: \`Dockerfile\`, \`docker-compose*.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- Resources: \`resources/**\`" >> $GITHUB_STEP_SUMMARY

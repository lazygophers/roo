<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .connecting { background: #e6f3ff; color: #0066cc; }
        .connected { background: #e6ffe6; color: #006600; }
        .error { background: #ffe6e6; color: #cc0000; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>SSE System Monitor Test</h1>
    <div id="status" class="status connecting">è¿æ¥ä¸­...</div>
    <div id="data" class="data">ç­‰å¾…æ•°æ®...</div>

    <script>
        let eventSource;
        let dataCount = 0;

        function connectSSE() {
            console.log('ğŸ”„ Connecting to SSE...');
            document.getElementById('status').className = 'status connecting';
            document.getElementById('status').textContent = 'è¿æ¥ä¸­...';

            eventSource = new EventSource('/api/system/monitor/stream');

            eventSource.onopen = function(event) {
                console.log('âœ… SSE connection opened', event);
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'å·²è¿æ¥ - ç­‰å¾…æ•°æ®...';
            };

            eventSource.onmessage = function(event) {
                dataCount++;
                console.log('ğŸ“¥ Received data', event.data);

                try {
                    const data = JSON.parse(event.data);
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = `å·²è¿æ¥ - å·²æ¥æ”¶ ${dataCount} æ¡æ•°æ®`;

                    const dataDiv = document.getElementById('data');
                    dataDiv.textContent = `æœ€æ–°æ•°æ® (${new Date().toLocaleTimeString()}):\n` + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                    document.getElementById('data').textContent = 'JSONè§£æé”™è¯¯: ' + event.data;
                }
            };

            eventSource.onerror = function(event) {
                console.error('âŒ SSE error:', event);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'è¿æ¥é”™è¯¯ - ReadyState: ' + eventSource.readyState;

                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('ğŸ”„ Connection closed, attempting to reconnect in 5 seconds...');
                    setTimeout(connectSSE, 5000);
                }
            };
        }

        // å¼€å§‹è¿æ¥
        connectSSE();

        // é¡µé¢å…³é—­æ—¶æ¸…ç†è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
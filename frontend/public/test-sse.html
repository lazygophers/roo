<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .connecting { background: #e6f3ff; color: #0066cc; }
        .connected { background: #e6ffe6; color: #006600; }
        .error { background: #ffe6e6; color: #cc0000; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>SSE System Monitor Test</h1>
    <div id="status" class="status connecting">连接中...</div>
    <div id="data" class="data">等待数据...</div>

    <script>
        let eventSource;
        let dataCount = 0;

        function connectSSE() {
            console.log('🔄 Connecting to SSE...');
            document.getElementById('status').className = 'status connecting';
            document.getElementById('status').textContent = '连接中...';

            eventSource = new EventSource('/api/system/monitor/stream');

            eventSource.onopen = function(event) {
                console.log('✅ SSE connection opened', event);
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '已连接 - 等待数据...';
            };

            eventSource.onmessage = function(event) {
                dataCount++;
                console.log('📥 Received data', event.data);

                try {
                    const data = JSON.parse(event.data);
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = `已连接 - 已接收 ${dataCount} 条数据`;

                    const dataDiv = document.getElementById('data');
                    dataDiv.textContent = `最新数据 (${new Date().toLocaleTimeString()}):\n` + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error('❌ Parse error:', error);
                    document.getElementById('data').textContent = 'JSON解析错误: ' + event.data;
                }
            };

            eventSource.onerror = function(event) {
                console.error('❌ SSE error:', event);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = '连接错误 - ReadyState: ' + eventSource.readyState;

                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('🔄 Connection closed, attempting to reconnect in 5 seconds...');
                    setTimeout(connectSSE, 5000);
                }
            };
        }

        // 开始连接
        connectSSE();

        // 页面关闭时清理连接
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
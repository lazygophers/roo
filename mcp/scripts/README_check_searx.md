# 🔍 Searx 实例可用性检测器

一个高性能、并发的 Searx 实例可用性检测工具，可自动检测多个 Searx 实例的健康状态并更新配置文件。

## ✨ 功能特性

- **🚀 高性能并发检测**：支持自定义并发数，大幅提升检测速度
- **📊 实时进度显示**：使用 tqdm 显示检测进度和实时状态
- **🔄 自动配置更新**：自动更新 config.yaml 中的可用实例列表
- **💾 配置备份**：更新前自动备份原配置文件
- **📈 详细统计报告**：显示可用/不可用实例、响应时间等统计信息
- **🛡️ 健壮的错误处理**：优雅处理超时、SSL错误、连接失败等异常
- **🎛️ 灵活的命令行接口**：支持多种参数定制检测行为

## 📦 依赖要求

```bash
pip install requests pyyaml tqdm
```

## 🚀 快速开始

### 基础用法

```bash
# 使用默认参数检测所有实例
python scripts/check_searx.py

# 查看帮助信息
python scripts/check_searx.py --help
```

### 高级用法

```bash
# 使用 20 个并发连接，5秒超时
python scripts/check_searx.py --concurrent 20 --timeout 5

# 模拟运行，不更新配置文件
python scripts/check_searx.py --dry-run

# 只检测，不更新配置
python scripts/check_searx.py --no-update

# 显示详细日志
python scripts/check_searx.py --verbose

# 从文件读取主机列表
python scripts/check_searx.py --host-file hosts.txt

# 使用项目的 searx 工具进行检测
python scripts/check_searx.py --use-tool
```

## 📋 命令行参数

| 参数 | 简写 | 描述 | 默认值 |
|------|------|------|--------|
| `--concurrent` | `-c` | 最大并发数 | 10 |
| `--timeout` | `-t` | 请求超时时间(秒) | 10 |
| `--query` | `-q` | 测试查询字符串 | test |
| `--config` | | 配置文件路径 | config.yaml |
| `--host-file` | | 从文件读取主机列表 | - |
| `--use-tool` | | 使用项目 searx 工具检测 | False |
| `--dry-run` | | 模拟运行，不更新配置 | False |
| `--verbose` | `-v` | 显示详细日志 | False |
| `--no-update` | | 只检测，不更新配置文件 | False |

## 📊 输出示例

```
🚀 Searx 实例可用性检测器
============================================================
配置: 并发=20, 超时=5s, 查询='test'
模式: 直接HTTP
============================================================

📋 准备检测 51 个 Searx 实例...
检测 Searx 实例: 100%|███████████████| 51/51 [00:21<00:00]

============================================================
📊 检测结果统计
============================================================

✅ 可用实例 (26/51):
   1. https://sousuo.emoe.top                  [1.70s]
   2. https://searxng.vyro.ai                  [1.99s]
   3. https://martechia.online                 [2.03s]
   ...

❌ 不可用实例 (25/51):
   1. https://aimonitor.xiaocg.xyz             - Connection error
   2. https://searxng.ctbot.tech               - 403 Forbidden
   ...

⚡ 性能统计:
  平均响应时间: 2.94s
  最快响应时间: 1.70s
  最慢响应时间: 4.37s

============================================================
⏱️  总耗时: 21.20 秒

✨ 检测完成！找到 26 个可用实例
```

## 🏗️ 架构设计

### 核心组件

1. **SearxChecker**：核心检测器类
   - 支持直接 HTTP 检测和工具检测两种模式
   - 使用连接池和重试策略优化网络请求
   - 并发执行检测任务

2. **ConfigManager**：配置文件管理器
   - 自动备份原配置文件
   - 原子更新操作确保配置安全
   - 保留原配置中的其他字段

3. **CheckResult**：检测结果数据类
   - 记录每个实例的检测结果
   - 包含响应时间、错误信息等元数据

### 技术亮点

- **并发优化**：使用 ThreadPoolExecutor 实现高效并发
- **连接复用**：使用 requests.Session 复用 HTTP 连接
- **智能重试**：自动重试失败的请求，提高成功率
- **原子操作**：使用临时文件 + rename 确保配置更新的原子性
- **类型注解**：完整的类型注解提高代码可维护性

## 📈 性能优化

- **并发检测**：相比串行检测，速度提升 10-20 倍
- **连接池**：复用 TCP 连接，减少握手开销
- **智能超时**：合理的超时设置避免长时间等待
- **进度反馈**：实时进度条减少等待焦虑

## 🔧 配置文件格式

脚本会自动更新 `config.yaml` 中的 `searx_hosts` 字段：

```yaml
# config.yaml
searx_hosts:
  - "https://sousuo.emoe.top"
  - "https://searxng.vyro.ai"
  - "https://martechia.online"
  # ... 更多可用实例
```

## 📝 主机列表文件格式

如果使用 `--host-file` 参数，文件格式如下：

```
# hosts.txt
https://searx.example1.com
https://searx.example2.com
# 注释行会被忽略
https://searx.example3.com
```

## 🐛 故障排除

### 常见问题

1. **SSL 证书错误**
   - 某些实例使用自签名证书或证书配置有误
   - 脚本会自动跳过这些实例

2. **超时问题**
   - 可以通过 `--timeout` 参数调整超时时间
   - 建议根据网络状况设置合理的超时值

3. **连接被拒绝**
   - 某些实例可能暂时下线或防火墙限制
   - 脚本会自动标记为不可用

## 🚀 最佳实践

1. **定期检测**：建议定期运行脚本更新可用实例列表
2. **合理并发**：根据系统性能设置合适的并发数（10-30）
3. **备份配置**：虽然脚本会自动备份，但建议定期手动备份重要配置
4. **监控日志**：使用 `--verbose` 查看详细日志，便于问题排查

## 📊 与原版对比

| 功能 | 原版 | 新版 |
|------|------|------|
| 检测方式 | langchain 库 | 原生 requests / 项目工具 |
| 并发支持 | ❌ 串行 | ✅ 高并发 |
| 进度显示 | ✅ 基础 | ✅ 详细进度条 |
| 配置更新 | ❌ 手动 | ✅ 自动更新 |
| 配置备份 | ❌ | ✅ 自动备份 |
| 命令行参数 | ❌ | ✅ 丰富参数 |
| 错误处理 | 基础 | 健壮完善 |
| 统计报告 | ❌ | ✅ 详细统计 |
| 性能 | 慢 | 快 10-20 倍 |

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License